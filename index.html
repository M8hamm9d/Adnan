<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù†Ø¸Ø§Ù… ØªÙˆØ«ÙŠÙ‚ Ø§Ù„Ø£Ø¶Ø±Ø§Ø± Ø§Ù„Ù…ÙŠØ¯Ø§Ù†ÙŠ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --bg: #f4f7f6; }
        * { box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); margin: 0; padding: 10px; }
        
        .app-container { max-width: 800px; margin: auto; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .full-width { grid-column: span 2; }
        
        @media (max-width: 600px) { .form-grid { grid-template-columns: 1fr; } .full-width { grid-column: span 1; } }

        label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 14px; color: #444; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; background: #fff; }
        
        #coords { background: #f0f4f8; cursor: pointer; font-weight: bold; color: var(--accent); }
        
        /* ØªØ­Ø³ÙŠÙ†: Ù…Ù†Ø·Ù‚Ø© Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…Ø¶Ø§ÙØ© */
        .preview-area { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
        .preview-img { width: 70px; height: 70px; object-fit: cover; border-radius: 5px; border: 1px solid #ddd; }

        .btn-group { display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap; }
        button { flex: 1; min-width: 140px; padding: 16px; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; color: white; transition: 0.3s; font-size: 16px; }
        .btn-pdf { background: #e74c3c; }
        .btn-excel { background: #2980b9; }
        button:active { transform: scale(0.98); }

        #report-output { 
            position: absolute; left: -9999px; top: -9999px; 
            width: 210mm; background: white; padding: 20mm; direction: rtl; 
        }
        .report-header { text-align: center; border-bottom: 4px double #333; margin-bottom: 30px; padding-bottom: 10px; }
        .info-row { display: flex; border-bottom: 1px solid #eee; padding: 12px 0; font-size: 16px; }
        .info-label { font-weight: bold; width: 200px; color: var(--primary); }
        
        .images-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 25px; }
        .images-grid img { width: 100%; height: 180px; object-fit: cover; border: 1px solid #ddd; border-radius: 8px; }
        
        #loader { display: none; text-align: center; color: var(--accent); font-weight: bold; margin-top: 10px; }
    </style>
</head>
<body>

<div class="app-container">
    <h2 style="text-align: center; color: var(--primary); margin-top: 0;">ğŸ› ï¸ Ù†Ø¸Ø§Ù… ØªÙˆØ«ÙŠÙ‚ Ø§Ù„Ø£Ø¶Ø±Ø§Ø±</h2>
    
    <div class="form-grid">
        <div class="form-group">
            <label>Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹:</label>
            <input type="text" id="refNum" placeholder="Ù…Ø«Ø§Ù„: 12345">
        </div>

        <div class="form-group">
            <label>Ù†ÙˆØ¹ Ø§Ù„Ø£Ø¶Ø±Ø§Ø±:</label>
            <select id="damageType">
                <option value="" disabled selected>-- Ø§Ø®ØªØ± Ø§Ù„Ù†ÙˆØ¹ --</option>
                <option value="Ø­ÙˆØ§Ø¬Ø² Ø­Ø¯ÙŠØ¯ÙŠØ©">Ø­ÙˆØ§Ø¬Ø² Ø­Ø¯ÙŠØ¯ÙŠØ©</option>
                <option value="Ø­ÙˆØ§Ø¬Ø² Ø®Ø±Ø³Ø§Ù†ÙŠØ©">Ø­ÙˆØ§Ø¬Ø² Ø®Ø±Ø³Ø§Ù†ÙŠØ©</option>
                <option value="Ø­Ù…Ø§ÙŠØ§Øª Ø®Ø±Ø³Ø§Ù†ÙŠØ©">Ø­Ù…Ø§ÙŠØ§Øª Ø®Ø±Ø³Ø§Ù†ÙŠØ©</option>
                <option value="Ø­Ù…Ø§ÙŠØ§Øª Ø§Ù„Ø±Ø¨Ø±Ø§Ø¨">Ø­Ù…Ø§ÙŠØ§Øª Ø§Ù„Ø±Ø¨Ø±Ø§Ø¨</option>
                <option value="Ø¯Ù‡Ø§Ù†Ø§Øª">Ø¯Ù‡Ø§Ù†Ø§Øª</option>
                <option value="Ø£Ø³ÙÙ„Øª">Ø£Ø³ÙÙ„Øª</option>
                <option value="Ù„ÙˆØ§Ø¦Ø­ ØªØ­Ø°ÙŠØ±ÙŠØ©">Ù„ÙˆØ§Ø¦Ø­ ØªØ­Ø°ÙŠØ±ÙŠØ©</option>
                <option value="Ù„ÙˆØ§Ø¦Ø­ Ø£Ø±Ø´Ø§Ø¯ÙŠØ©">Ù„ÙˆØ§Ø¦Ø­ Ø£Ø±Ø´Ø§Ø¯ÙŠØ©</option>
                <option value="Ø£Ø­Ø¬Ø§Ø± Ø§Ù„Ø±ØµÙŠÙ">Ø£Ø­Ø¬Ø§Ø± Ø§Ù„Ø±ØµÙŠÙ</option>
            </select>
        </div>

        <div class="form-group full-width">
            <label>Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ (Ø§Ù†Ù‚Ø± Ù„Ù„Ø¬Ù„Ø¨):</label>
            <input type="text" id="coords" readonly placeholder="Ø§Ø¶ØºØ· Ù‡Ù†Ø§ Ù„ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ" onclick="getLocation()">
        </div>

        <div class="form-group full-width">
            <label>ÙˆØµÙ Ø§Ù„Ù…ÙˆÙ‚Ø¹:</label>
            <textarea id="locationDesc" rows="2" placeholder="Ø£Ø¯Ø®Ù„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹..."></textarea>
        </div>

        <div class="form-group full-width">
            <label>Ø§Ù„ØµÙˆØ± (ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø®ØªÙŠØ§Ø± Ø¹Ø¯Ø© ØµÙˆØ±):</label>
            <input type="file" id="photoInput" multiple accept="image/*" onchange="handleImages()">
            <div id="imagePreview" class="preview-area"></div>
        </div>
    </div>

    <div class="btn-group">
        <button class="btn-pdf" onclick="generatePDF()">ğŸ“„ Ø¥ØµØ¯Ø§Ø± ØªÙ‚Ø±ÙŠØ± PDF</button>
        <button class="btn-excel" onclick="generateExcel()">ğŸ“Š ØªØµØ¯ÙŠØ± Excel</button>
    </div>
    <div id="loader">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...</div>
</div>

<div id="report-output">
    <div class="report-header">
        <h1 style="margin: 0;">ØªÙ‚Ø±ÙŠØ± Ø­ØµØ± ÙˆØªÙˆØ«ÙŠÙ‚ Ø£Ø¶Ø±Ø§Ø± Ø§Ù„Ø­ÙˆØ§Ø¯Ø«</h1>
        <p>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©: <span id="resDate"></span></p>
    </div>
    <div class="report-content">
        <div class="info-row"><span class="info-label">Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹:</span> <span id="resRef"></span></div>
        <div class="info-row"><span class="info-label">Ù†ÙˆØ¹ Ø§Ù„Ø£Ø¶Ø±Ø§Ø± Ø§Ù„Ù…ÙƒØªØ´ÙØ©:</span> <span id="resType"></span></div>
        <div class="info-row"><span class="info-label">Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠØ©:</span> <span id="resCoords"></span></div>
        <div class="info-row"><span class="info-label">ÙˆØµÙ Ø§Ù„Ù…ÙˆÙ‚Ø¹:</span> <span id="resDesc"></span></div>
        
        <h3 style="margin-top: 30px; border-right: 6px solid var(--accent); padding-right: 12px;">Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ù…ØµÙˆØ±Ø©:</h3>
        <div id="resPhotos" class="images-grid"></div>
    </div>
</div>

<script>
    let capturedImages = [];

    function getLocation() {
        if (navigator.geolocation) {
            document.getElementById('coords').value = "Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹...";
            navigator.geolocation.getCurrentPosition(pos => {
                document.getElementById('coords').value = `${pos.coords.latitude.toFixed(6)}, ${pos.coords.longitude.toFixed(6)}`;
            }, () => {
                alert("ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹ØŒ ØªØ£ÙƒØ¯ Ù…Ù† ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù€ GPS");
                document.getElementById('coords').value = "";
            }, { enableHighAccuracy: true });
        }
    }

    function handleImages() {
        const files = document.getElementById('photoInput').files;
        const previewArea = document.getElementById('imagePreview');
        previewArea.innerHTML = '';
        capturedImages = [];
        
        Array.from(files).forEach(file => {
            const reader = new FileReader();
            reader.onload = (e) => {
                capturedImages.push(e.target.result);
                const img = document.createElement('img');
                img.src = e.target.result;
                img.className = 'preview-img';
                previewArea.appendChild(img);
            };
            reader.readAsDataURL(file);
        });
    }

    async function generatePDF() {
        const ref = document.getElementById('refNum').value;
        if (!ref) { alert("Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹"); return; }
        
        const loader = document.getElementById('loader');
        loader.style.display = "block";

        document.getElementById('resRef').innerText = ref;
        document.getElementById('resType').innerText = document.getElementById('damageType').value;
        document.getElementById('resCoords').innerText = document.getElementById('coords').value || "ØºÙŠØ± Ù…ØªÙˆÙØ±";
        document.getElementById('resDesc').innerText = document.getElementById('locationDesc').value;
        document.getElementById('resDate').innerText = new Date().toLocaleString('ar-SA');

        const photoDiv = document.getElementById('resPhotos');
        photoDiv.innerHTML = '';
        capturedImages.forEach(src => {
            const img = document.createElement('img');
            img.src = src;
            photoDiv.appendChild(img);
        });

        const reportElement = document.getElementById('report-output');
        reportElement.style.position = "static";
        reportElement.style.left = "0";

        html2canvas(reportElement, { 
            scale: 2, 
            useCORS: true,
            logging: false,
            allowTaint: true
        }).then(canvas => {
            const imgData = canvas.toDataURL('image/jpeg', 0.9);
            const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
            const width = pdf.internal.pageSize.getWidth();
            const height = (canvas.height * width) / canvas.width;
            
            pdf.addImage(imgData, 'JPEG', 0, 0, width, height);
            pdf.save(`ØªÙ‚Ø±ÙŠØ±_Ø£Ø¶Ø±Ø§Ø±_${ref}.pdf`);
            
            reportElement.style.position = "absolute";
            reportElement.style.left = "-9999px";
            loader.style.display = "none";
        }).catch(err => {
            alert("Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ PDF");
            loader.style.display = "none";
        });
    }

    function generateExcel() {
        const data = [{
            "Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹": document.getElementById('refNum').value,
            "Ù†ÙˆØ¹ Ø§Ù„Ø£Ø¶Ø±Ø§Ø±": document.getElementById('damageType').value,
            "Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª": document.getElementById('coords').value,
            "ÙˆØµÙ Ø§Ù„Ù…ÙˆÙ‚Ø¹": document.getElementById('locationDesc').value,
            "ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©": new Date().toLocaleString('ar-SA')
        }];
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Ø§Ù„Ø£Ø¶Ø±Ø§Ø±");
        XLSX.writeFile(wb, `ØªÙ‚Ø±ÙŠØ±_Ø£Ø¶Ø±Ø§Ø±_${document.getElementById('refNum').value || 'Ø¬Ø¯ÙŠØ¯'}.xlsx`);
    }
</script>
</body>
</html>